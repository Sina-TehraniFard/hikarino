# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code) に対するガイダンスを提供します。

# 🚨 最重要事項 - コミットメッセージ禁止事項

## 絶対に含めてはいけない内容
以下をコミットメッセージに含めることは**重大な違反行為**です：

```
🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### 理由
- プロジェクトの専門性と信頼性を損なう
- コミット履歴の品質を著しく低下させる
- 開発者の貢献を不適切に表現する

### 正しいコミットメッセージ
- 機能説明と技術仕様のみを記述
- 客観的で事実に基づく内容
- Conventional Commits形式に従った簡潔な表現

### 必須テンプレート
コミットメッセージには以下のテンプレートを使用すること：

```
<type>: <description>

<body>

Developed-by: Sina TehraniFard <tf.sina.system@gmail.com>
```

**例：**
```
feat: ユーザー認証システムの実装

- Firebase Authentication統合
- ログイン/ログアウト機能
- セッション管理とルート保護

Developed-by: Sina TehraniFard <tf.sina.system@gmail.com>
```

# 追加指示
- gitワークフロー @docs/git-instructions.md
- gitガイドライン @docs/git-guidelines.md
- スタイリングガイド @STYLING_GUIDE.md

## コード品質ガイドライン

### 客観性とプロフェッショナリズムの原則

#### 既定的評価の禁止
- **肯定的形容詞の使用禁止**: 「素晴らしい」「完璧」「最高」「美しい」等の主観的評価表現を使用しない
- **コミットメッセージの客観性**: 機能説明と技術仕様に限定し、品質評価を含めない
- **コード品質の客観的記述**: 実装内容・機能・技術仕様のみを記述する

#### 批判的思考の維持
- **実装検証の重要性**: 常に潜在的な問題・改善点・制限事項を考慮する
- **品質保証の態度**: 自己満足を排除し、継続的な改善機会を探求する
- **外部評価への配慮**: 第三者が見た際の信頼性と専門性を重視する

#### プロフェッショナルな表現方法
- **事実ベースの記述**: 実装した機能・解決した問題・使用した技術のみを記述
- **中立的表現の採用**: 感情的・評価的表現を避け、技術的事実に基づく記述
- **継続改善の姿勢**: 完成度より改善可能性に焦点を当てた記述

### コメントの書き方
- **番号付きコメントは禁止**: コメントに「1. 」「2. 」「3. 」などの番号を振ってはいけません
- **理由**: コードの追加・削除・移動の際に番号の付け直しが必要になり、保守コストが増大します
- **代替案**: セクション名や機能名で明確に区別する
- **例外**: 手順を説明する場合は「Step 1」「Step 2」のように明示的に手順であることを示す

#### ❌ 悪い例
```typescript
// 1. ユーザー認証
const user = getUser();
// 2. データ取得  
const data = fetchData();
// 3. 表示更新
updateUI(data);
```

#### ✅ 良い例
```typescript
// ユーザー認証
const user = getUser();
// データ取得  
const data = fetchData();
// 表示更新
updateUI(data);
```

## プロジェクト概要

ヒカリノは、Next.js 15で構築されたAI搭載の日本語タロット占いサービスです。コイン制の課金システムと、キャラクター主導のAI解釈が特徴です。バックエンドサービスにFirebase、決済にStripe、「ヒカリノ」キャラクターペルソナを通じたパーソナライズされたタロット読みの生成にOpenAI APIを使用しています。

## 開発コマンド

### 基本コマンド
- `npm run dev` - Turbopackを使用した開発サーバーの起動
- `npm run build` - 本番環境用ビルド
- `npm run lint` - ESLintバリデーションの実行
- `npm run start` - 本番サーバーの起動

### テスト
現在テストフレームワークは設定されていません。テストを追加する際は、ユーザーに希望するテストアプローチを確認してください。

## アーキテクチャと重要な概念

### 技術スタック
- **Next.js 15** (App Routerアーキテクチャ)
- **React 19** with TypeScript 5
- **Tailwind CSS 4** (新しいインラインテーマ構文を使用)
- **Firebase** (Auth, Firestore, Cloud Functions)
- **Stripe** (決済処理)
- **OpenAI API** (AI搭載の解釈生成)

### コアビジネスロジック
- **タロットシステム**: 大アルカナ22枚のカード（正位置・逆位置）
- **コインシステム**: 1回の占いに100コイン必要
- **キャラクター設計**: 「ヒカリノ」が温かい姉のような導きを提供
- **セキュリティ**: Cloud Functionsによるサーバーサイドのカード引きとコイン検証

### 主要ディレクトリ
- `src/app/` - Next.js App RouterのページとAPIルート
- `src/components/` - 再利用可能なUIコンポーネント
- `src/lib/firebase.ts` - Firebase設定と初期化
- `src/lib/firestore/` - データベース操作とスキーマ
- `src/lib/tarot.ts` - タロットカードの定義とロジック
- `src/prompts/` - AIキャラクタープロンプトテンプレート
- `src/contexts/` - React Contextプロバイダー（CoinContext）

### キャラクターガイドライン
AIプロンプトやキャラクターインタラクションを扱う際は、ヒカリノの人格を維持してください：
- 温かく、姉のような、サポート的な口調
- 困難について正直でありながら希望を提供
- ユーザーが聞いてもらえている感覚と優しい励ましを提供
- 指導に対する判断的でないアプローチ

### セキュリティパターン
- 機密のFirebaseやStripeキーをクライアントコードで公開しない
- コイン消費の検証はCloud Functionsを通じてサーバーサイドで行う
- カード引きのランダム化は操作を防ぐためサーバーで実行
- すべての決済処理はセキュリティのためStripe webhookを使用

### 状態管理
- コイン関連の状態管理には`CoinContext`を使用
- 認証状態には`useAuth`フックを使用
- すべてのコイン取引はサーバーサイド検証
- 占い履歴の永続化にはFirestoreを使用

### 設定メモ
- TypeScript strict modeが有効で、`@/*`パスマッピング設定済み
- ESLintはNext.jsコアウェブバイタル設定を使用
- Tailwind CSS 4はシステム設定に基づく自動ダークモード
- `main`ブランチでの自動バージョニング用semantic releaseが設定済み

### Firebase構造
Firestore操作を行う際は、`src/lib/firestore/`の既存パターンを使用してください：
- ユーザーのコイン残高は安全に保存
- カード詳細と解釈を含む占い履歴
- Cloud Functionsがサーバーサイドのコイン減算を処理

### 決済統合
Stripe統合には以下が必要：
- サーバーサイドのコイン購入処理
- 決済確認のためのWebbook検証
- Cloud Functionsを通じた安全なコイン残高更新

### モーダルダイアログの使用方法

#### MessageDialogコンポーネント
ユーザーへの通知、警告、エラー表示に統一されたモーダルダイアログを使用してください。

**使用例：**
```typescript
import MessageDialog from "@/components/ui/MessageDialog";

// 状態管理
const [showMessage, setShowMessage] = useState(false);

// ダイアログ表示
<MessageDialog
  isOpen={showMessage}
  onClose={() => setShowMessage(false)}
  type="warning"  // 'info' | 'warning' | 'error' | 'success'
  title="カスタムタイトル"  // オプション（省略時は自動設定）
  message="表示したいメッセージ"
/>
```

**タイプ別の特徴：**
- **info（情報）**: 💭アイコン、青色、「了解」ボタン
- **warning（警告）**: ⚠️アイコン、黄色、「はい」ボタン
- **error（エラー）**: ❌アイコン、赤色、「OK」ボタン
- **success（成功）**: ✅アイコン、エメラルド色、「OK」ボタン

**使用ガイドライン：**
- ユーザーの操作を中断させる重要な通知に使用
- 下部の小さなメッセージではなく、視認性の高いモーダルを使用
- メッセージは簡潔に、必要な情報のみを伝える
- 適切なタイプを選択してユーザーに状況を明確に伝える

### UIレイアウト構造

#### PC版（768px以上）
- **左サイドバー常時表示**: `src/components/ui/Sidebar.tsx`を使用
- **サイドバー幅**: 256px固定
- **メインコンテンツ**: サイドバー分のマージンを設定
- **ヘッダー**: サイドバーと重複しないよう調整

#### モバイル版（768px未満）
- **ハンバーガーメニュー**: `src/components/ui/HamburgerMenu.tsx`を使用
- **スライドアウト方式**: 右から左にメニューが出現
- **オーバーレイ**: メニュー表示時は背景をブラー処理

#### 重要な実装規則
- **機能完全一致**: SidebarとHamburgerMenuの機能は完全に一致させること
- **レスポンシブ切り替え**: `md:`ブレークポイント（768px）で切り替え
- **ユーザー情報表示**: 両方のメニューで同じユーザー情報を表示
- **メニュー項目**: ホーム・履歴・ログイン/ログアウトを同じ順序で配置